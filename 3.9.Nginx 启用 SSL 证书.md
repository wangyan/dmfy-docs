# Nginx 配置 Let’s Encrypt 证书

## 一、acme.sh 签发证书

### 1.1. 安装 acme.sh

```bash
apt install cron netcat -y #debian
yum install nc socat -y #rhel

curl https://get.acme.sh | sh
```

### 1.2. 生成 dhparam

```bash
sudo chmod 777 /usr/local/nginx/conf/ssl-certs && \
sudo chmod o+t /usr/local/nginx/conf/ssl-certs

openssl dhparam -out /etc/nginx/ssl-certs/dhparam.pem 2048
curl https://ssl-config.mozilla.org/ffdhe2048.txt > /etc/nginx/ssl-certs/dhparam.pem
```

### 1.3. 签发证书

#### 1.3.1. 导入 key

> 文档：<https://github.com/Neilpang/acme.sh/tree/master/dnsapi>

```bash
# cloudflare
export CF_Key="" && \
export CF_Email=""

# dnspod
export DP_Id="" && \
export DP_Key=""
```

#### 1.3.2. DNS-alias 模式

> 文档：<https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode>

```bash
# ECC 证书
acme.sh --issue --home /usr/local/nginx/conf/ssl-certs \
        -d wangyan.org --challenge-alias wyflr.com --dns dns_cf \
        -d *.wangyan.org \
        -d *.cdn.wangyan.org \
        --keylength ec-256
```

#### 1.3.3. DNS 模式

```bash
# ECC 证书
acme.sh --issue \
        -d xubiya.com  -d '*.xubiya.com' --dns dns_cf --keylength ec-256
```

## 二、Nginx SSL 配置

### 2.1. 自动生成配置文件

<https://ssl-config.mozilla.org>

```nginx
# generated by  https://ssl-config.mozilla.org
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    # redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate
    ssl_certificate /path/to/signed_cert_plus_intermediates;
    ssl_certificate_key /path/to/private_key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions
    ssl_session_tickets off;

    # curl https://ssl-config.mozilla.org/ffdhe2048.txt > /path/to/dhparam.pem
    ssl_dhparam /path/to/dhparam.pem;

    # intermediate configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # HSTS (ngx_http_headers_module is required) (63072000 seconds)
    add_header Strict-Transport-Security "max-age=63072000" always;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # verify chain of trust of OCSP response using Root CA and Intermediate certs
    ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;

    # replace with the IP address of your resolver
    resolver 127.0.0.1;
}
```

### 2.2. 启用 ssl_stapling_file

#### 2.2.1. 获取 lets-encrypt 证书

```bash
cd /etc/nginx/ssl-certs/ && \
wget https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem
```

#### 2.2.2. 新版 openssl

```bash
openssl ocsp -no_nonce \
   -respout dmfy.gov.cn/ocsp.resp \
   -issuer lets-encrypt-x3-cross-signed.pem \
   -cert dmfy.gov.cn/fullchain.cer \
   -url http://ocsp.int-x3.letsencrypt.org/ \
   -header "HOST=ocsp.int-x3.letsencrypt.org"
```

#### 2.2.3. 旧版 openssl

```bash
openssl ocsp -no_nonce \
   -respout example.com/ocsp.resp \
   -issuer lets-encrypt-x3-cross-signed.pem \
   -cert example.com/example.com.cer \
   -CAfile ca.cer \
   -VAfile ca.cer \
   -url http://ocsp.int-x3.letsencrypt.org/ \
   -header HOST "ocsp.int-x3.letsencrypt.org"
```

#### 2.2.4. 配置与验证

```nginx
ssl_stapling_file /etc/nginx/ssl-certs/wangyan.org/ocsp.resp;
```

验证

```bash
echo QUIT | openssl s_client -connect www.dmfy.gov.cn:443 -status 2> /dev/null | grep -A 17 'OCSP response:' | grep -B 17 'Next Update'
```

### 2.3. 自动更新 ssl_stapling_file

vim update_ocsp_cache.sh

```bash
#!/bin/bash
#############################
#
# OCSP Cache Updater
#   by Qu Chao
#
# ---------------------------
#
# Usage:
#   % update_ocsp_cache "example.com"
#
# ---------------------------
#
#############################

if [ -z $1 ]; then
    echo -e "No domain is specified!" >&2
    exit 1
fi

############################
# CONFIGS
############################

LE_DIR="/etc/nginx/ssl-certs"
GEN_NUM="x3"

############################
# DEFAULTS
############################

DOMAIN=$1
CERT_DIR="${LE_DIR}/${DOMAIN}"
CHAINED_CERT="${CERT_DIR}/fullchain.cer"
ISSUER_CERT="${LE_DIR}/lets-encrypt-${GEN_NUM}-cross-signed.pem"
CA_FILE="${CERT_DIR}/ca.cer"
OCSP_RESP_FILE="${CERT_DIR}/ocsp.resp"
OCSP_REPLY_FILE="${CERT_DIR}/ocsp.reply"

############################
# MAIN
############################
# Functions
existence_pattern_check(){
    [ -n "$1" ] && [ -e "$1" ] && ( [ "${2:-file}" = "file" ] && ( [ -f "$1" ] || [ -L "$1" ] ) || [ -d "$1" ] ) && [ -r "$1" ]
}

# Params Validation
if ! existence_pattern_check "${LE_DIR}" "dir"; then
    echo -e "Let's Encrypt folder is missing!" >&2
    exit 1
elif ! existence_pattern_check "${CERT_DIR}" "dir"; then
    echo -e "Domain cert folder is missing!" >&2
    exit 1
elif ! existence_pattern_check "${CHAINED_CERT}" || ! existence_pattern_check "${ISSUER_CERT}" || ! existence_pattern_check "${CA_FILE}"; then
    echo -e "Required certs file is missing!" >&2
    exit 1
fi

# Get OCSP URI & HOST
OCSP_URL=$(openssl x509 -in "${CHAINED_CERT}"  -text | grep "OCSP - URI:" | cut -d: -f2,3)
OCSP_HOST=$(echo "${OCSP_URL}" | awk -F/ '{print $3}')

# Output OCSP response
openssl ocsp -no_nonce \
             -respout "${OCSP_RESP_FILE}.new" \
             -issuer "${ISSUER_CERT}" \
             -cert "${CHAINED_CERT}" \
             -CAfile "${CA_FILE}" \
             -VAfile "${CA_FILE}" \
             -url "${OCSP_URL}" \
             -header HOST "${OCSP_HOST}" > "${OCSP_REPLY_FILE}" 2>&1

# Check if it's all okay?
if  grep -q "Response verify OK" "${OCSP_REPLY_FILE}" && grep -q "${CHAINED_CERT}: good" "${OCSP_REPLY_FILE}" ; then
    if  cmp -s "${OCSP_RESP_FILE}.new" "${OCSP_RESP_FILE}" ; then
        # No news is good news
        rm "${OCSP_RESP_FILE}.new"

        echo -e "OCSP cache is up-to-date!"
    else
        # Update the cache file
        mv "${OCSP_RESP_FILE}.new" "${OCSP_RESP_FILE}"

        # reload nginx's config
        /usr/local/nginx/sbin/nginx -s reload

        echo -e "OCSP cache is updated!"
    fi
else
    # Bad things happen all the time
    cat "${OCSP_REPLY_FILE}" >&2

    echo -e "Failed to update OCSP cache!" >&2
fi

# Make a backup
mv "${OCSP_REPLY_FILE}" "${OCSP_REPLY_FILE}.old"
echo -e "Detailed log located at ${OCSP_REPLY_FILE}.old"
```

计划任务

```bash
1 * * * * /etc/nginx/ssl-certs/update_ocsp_cache.sh wangyan.org 2>&1 >/dev/null | (test -s /dev/stdin && /usr/bin/mail -s "$HOSTNAME - Hourly OCSP Cache Update" service@wangyan.org || echo 'OCSP Cache is Up-to-date!')
```

参考：

- [在 NginX 上为证书配置 OCSP Stapling](https://quchao.com/entry/how-to-configure-ocsp-stapling-on-nginx-for-the-certificates-issued-by-lets-encrypt/)
