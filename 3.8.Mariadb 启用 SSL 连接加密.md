# Mariadb 启用 SSL 连接加密

## 一、关于 SSL 连接加密

### 1.1. 概述

SSL 协议要求建立在可靠的传输层协议（TCP）之上。SSL 协议的优势在于它是与应用层协议独立无关的，高层的应用层协议（例如：HTTP、FTP、TELNET 等）能透明地建立于 SSL 协议之上。SSL 协议在应用层协议通信之前就已经完成加密算法、通信密钥的协商及服务器认证工作。在此之后应用层协议所传送的数据都会被加密，从而保证通信的私密性。

### 1.2. 名词解释

- **SSL（Secure Sockets Layer）：** 安全套接层，是一种安全协议，目的是为互联网通信提供安全及数据完整性保障，使用 X.509 认证。

- **TLS（Transport Layer Security）：** 安全传输层，IETF 将 SSL 标准化后的产物。TLS 可以理解为 SSL 的升级版，TLS 目前有三个版本：TLS1.0、TLS1.1、TLS1.2，目前常用的为 TLS1.2，server 配置通常三个版本均支持。

- **X.509 标准：** SSL 证书格式遵循 X.509 标准，X.509 是由国际电信联盟（ITU-T）制定的数字证书标准。X.509 给出的鉴别框架是一种基于公开密钥体制的鉴别业务密钥管理，即一个用户有两把密钥，公钥和私钥，同时该标准也规范了公开密钥认证、证书吊销列表、授权证书、证书路径验证算法等。

- **Openssl：** 一个开源的加密库，由 C 语言写成，SSL/TLS 协议基于该库进行的加解密。

- **认证机构CA（Certificate Authority）：** 在 HTTPS 中是一个很重要的角色，通常称之为认证中心，从广义上讲，认证中心还应该包括证书申请注册机构 RA（Registration Authority），它是数字证书的申请注册、证书签发的管理机构。而在公司内网，通常也可以自己搭建认证服务器，发送证书，简称“自签发证书”。

- **公钥（Public-key）：** 公共证书，由 CA 中心颁发的合法文件，可以在互联网传播。公钥证书文件的扩展名包括 crt、cer、key、der、pem、pem。公钥中包含颁发给哪个域名、公司名、加密算法、组织机构、有效期等信息。

- **私钥（private-key）：** 即通常就叫所谓的私钥，私钥在生成 CSR 文件的时候同时生产，后缀通常为 .key，由使用者自己保管，不可在互联网传播，极其重要。


## 二、创建 CA 证书

### 2.1. 生成 CA 私钥

```bash
mkdir -p /etc/my.cnf.d/certificates/ && \
cd /etc/my.cnf.d/certificates/

# CA 私钥
openssl genrsa 4096 > ca-key.pem
```

### 2.2. 创建 CA 自签名证书

```bash
# CA common Name : MariaDB admin
openssl req -new -x509 -nodes -days 365000 -key ca-key.pem -out ca-cert.pem
```

>Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Guangdong
Locality Name (eg, city) []:Zhuhai
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DMFY
Organizational Unit Name (eg, section) []:DMFY
Common Name (e.g. server FQDN or YOUR name) []:MariaDB admin
Email Address []:mariadb-admin@dmfy.gov.cn

## 三、创建服务器证书

### 3.1. 生成服务器私钥和签名请求

```bash
# Server common Name: MariaDB server
openssl req -newkey rsa:4096 -days 365000 -nodes -keyout server-key.pem -out server-req.pem
```

>Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Guangdong
Locality Name (eg, city) []:Zhuhai
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DMFY
Organizational Unit Name (eg, section) []:DMFY
Common Name (e.g. server FQDN or YOUR name) []:MariaDB server
Email Address []:mariadb-server@dmfy.gov.cn
A challenge password []:
An optional company name []:

### 3.2. 生成无需密码的服务器私钥

```bash
cp server-key.pem server-key.pem.secure #安全私钥
openssl rsa -in server-key.pem -out server-key.pem #不安全私钥
```

### 3.3. 签署服务器证书

```bash
#用 CA 证书对签名请求文件进行签发
openssl x509 -req -in server-req.pem -days 365000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
```

## 四、创建客户端证书

### 4.1. 生成客户端私钥和签名请求

```bash
# Client common Name: MariaDB client
openssl req -newkey rsa:4096 -days 365000 -nodes -keyout client-key.pem -out client-req.pem
```

>Country Name (2 letter code) [AU]:CN
State or Province Name (full name) [Some-State]:Guangdong
Locality Name (eg, city) []:Zhuhai
Organization Name (eg, company) [Internet Widgits Pty Ltd]:DMFY
Organizational Unit Name (eg, section) []:DMFY
Common Name (e.g. server FQDN or YOUR name) []:MariaDB client
Email Address []:mariadb-client@dmfy.gov.cn
A challenge password []:
An optional company name []:

### 4.2. 生成无需密码的客户端私钥

```bash
cp client-key.pem client-key.pem.secure #安全私钥
openssl rsa -in client-key.pem -out client-key.pem #不安全私钥
```

### 4.3. 签署客户端证书

```bash
# 用 CA 证书对签名请求文件进行签发
openssl x509 -req -in client-req.pem -days 365000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 -out client-cert.pem
```

## 五、验证证书有效性

```bash
openssl verify -CAfile ca-cert.pem server-cert.pem client-cert.pem
```

## 六、配置 MariaDB 启用 SSL

vim /etc/my.cnf.d/enable_tls.cnf

### 6.1. MariaDB 服务端设置

```
[mariadb]
# Use Secure Connections to transfer data
#
ssl_cert = /etc/my.cnf.d/certificates/server-cert.pem
ssl_key = /etc/my.cnf.d/certificates/server-key.pem
ssl_ca = /etc/my.cnf.d/certificates/ca-cert.pem
```

### 6.2. MariaDB 客户端设置

```
[client-mariadb]
...
ssl_cert = /etc/my.cnf.d/certificates/client-cert.pem
ssl_key = /etc/my.cnf.d/certificates/client-key.pem
ssl_ca = /etc/my.cnf.d/certificates/ca-cert.pem
ssl-verify-server-cert
```

> 如果请求中有 `REQUIRE X509`, `REQUIRE SUBJECT`, `REQUIRE ISSUER` 则必须启用双向TLS

重启

```bash
chown mysql:mysql /etc/my.cnf.d/certificates/ -R
systemctl restart mariadb
```

### 6.3. 验证

```bash
MariaDB [(none)]> SHOW VARIABLES LIKE 'have_ssl';

MariaDB [(none)]> SHOW VARIABLES LIKE '%ssl%';
MariaDB [(none)]> status;
MariaDB [(none)]> SHOW STATUS LIKE 'Ssl_cipher';

# update cert
MariaDB [(none)]> FLUSH SSL；

# 创建的用户默认启用SSL
GRANT ALL ON foo.* TO bar@localhost IDENTIFIED BY 'mypassword' REQUIRE SSL;
```

### 6.4. 启用双向 TLS

> 注意：启用双向 TLS，上面的 'CA common Name' 要填实际网址

```shell
mysql -udfcloud -p -h db.dmfy.gov.cn \
   --ssl-cert=/etc/my.cnf.d/certificates/client-cert.pem \
   --ssl-key=/etc/my.cnf.d/certificates/client-key.pem \
   --ssl-ca=/etc/my.cnf.d/certificates/ca-cert.pem \
   --ssl-verify-server-cert
```

官方文档：

- [Securing Connections for Client and Server](https://mariadb.com/kb/en/library/securing-connections-for-client-and-server/)
- [Secure Connections Overview](https://mariadb.com/kb/en/library/secure-connections-overview/)
- [Connecting to MariaDB](https://mariadb.com/kb/en/library/connecting-to-mariadb/)
- [SSL/TLS System Variables](https://mariadb.com/kb/en/library/ssltls-system-variables/)
- [How to setup MariaDB SSL and secure connections from clients](https://www.cyberciti.biz/faq/how-to-setup-mariadb-ssl-and-secure-connections-from-clients/)
