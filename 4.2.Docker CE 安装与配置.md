# Docker CE 安装与配置

## 一、CentOS 7 安装 Docker CE

<https://docs.docker.com/install/linux/docker-ce/centos/>

### 1.1. 卸载旧版本

```bash
sudo yum remove docker \
  docker-client \
  docker-client-latest \
  docker-common \
  docker-latest \
  docker-latest-logrotate \
  docker-logrotate \
  docker-selinux \
  docker-engine-selinux \
  docker-engine
```

### 1.2. 添加YUM源

```bash
yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 测试库
#yum-config-manager --enable  docker-ce-edge
#yum-config-manager --disable docker-ce-edge
#yum-config-manager --enable  docker-ce-test
#yum-config-manager --disable docker-ce-test
```

方法二：

```bash
tee /etc/yum.repos.d/docker.repo <<-'EOF'
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/main/centos/7/
enabled=1
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF
```

### 1.3. 安装 Docker CE

```bash
# 查看所有版本
 yum list docker-ce --showduplicates | sort -r

yum install -y docker-ce
yum install -y docker-engine（旧版）
```

### 1.4. 开机启动服务

```bash
systemctl enable docker.service && \
systemctl start docker
```

### 1.5. docker 用户组

docker 运行需要ROOT权限，其他用户运行docker命令需要使用sudo。因此需要创建非root用户添加到docker组

```bash
groupadd docker
usermod -aG docker dmfy
```

### 1.6. 卸载

```bash
yum -y remove docker-ce
rm -rf /var/lib/docker
```

## 二、CentOS 8 安装 Docker CE

```bash
dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo
dnf install docker-ce --nobest -y

systemctl start docker && \
systemctl enable docker

docker --version
```

使用 podman 替代 Docker

```shell
#yum module install container-tools
yum install podman
```

## 三、Ubuntu 安装 Docker CE

```bash
sudo apt-get update

sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo  add-apt-repository \
      "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) \
      stable"

sudo apt-get update

apt-get install -y docker-ce

apt-get purge docker-ce
sudo rm -rf /var/lib/docker
```

## 四、安装 docker-compose

via <https://docs.docker.com/compose/compose-file/>

```bash
curl -L https://github.com/docker/compose/releases/download/1.25.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose && \
chmod +x /usr/local/bin/docker-compose

# 国内镜像
curl -L https://get.daocloud.io/docker/compose/releases/download/1.25.0//docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose && \
chmod +x /usr/local/bin/docker-compose

docker-compose --version
```

更新

```bash
docker-compose pull
docker-compose up -d --remove-orphans
```

## 四、配置 Docker 加速器

### 4.1. docker-cn 官方（推荐）

```bash
mkdir -p /etc/docker
tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://registry.docker-cn.com"]
}
EOF
```

rhel 8

```bash
vim /etc/containers/registries.conf
```

### 4.2. 阿里云加速

```bash
mkdir -p /etc/docker
tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://rvg03xpp.mirror.aliyuncs.com"]
}
EOF
```


### 4.3. Daocloud 加速

```shell
curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://56c3a7e7.m.daocloud.io
systemctl restart docker.service
```

### 4.4. 重启生效

```bash
systemctl daemon-reload
systemctl restart docker
```

## 五、配置 docker-ssh 工具

### 5.1. 工具一：docker-ssh

<https://github.com/phusion/baseimage-docker>

```shell
curl --fail -L -O https://github.com/phusion/baseimage-docker/archive/master.tar.gz && \
tar xzf master.tar.gz && \
./baseimage-docker-master/install-tools.sh
```

### 5.2. 工具二：docker-ssh

<https://github.com/jpetazzo/nsenter/blob/master/docker-enter>

```shell
vim ~/.bashrc
# Source docker-ssh
if [ -f ~/.bashrc_docker ]; then
        . ~/.bashrc_docker
fi
```

## 六、容器备份

```shell
提交镜像
docker commit -p f95021fee3dc dfcloud

保存镜像
docker save dfcloud > ~/dfcloud

载入镜像
docker load -i ~/dfcloud
```

方法二：

```shell
导出容器
docker export 70fbab60962d > ~/seafile-container-20160811.tar

导入容器为一个镜像
cat ~/seafile-container-20160811.tar | docker import - seafile:latest
```

