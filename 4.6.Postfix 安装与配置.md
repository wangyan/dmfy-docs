# Postfix 安装与配置

## 一、基本原理

邮件投递过程基本上是由三个角色组成的，分别是 MUA(mail user agent)邮件用户代理（邮件客户端）, MTA(mail transfer agent)邮件传输代理（邮件发送服务器）, MDA(mail delivery agent)邮件投递代理（邮件接收服务器）。

那么 MTA 是怎么找到对方的邮件服务器？

```shell
# 域名 MX 记录
域名：example.com 目标主机：mail.exmaple.com

# 域名 A 记录
域名：mail.example.com IP地址：123.123.123.123
```

这样，当我们发到`@example.com`的时候，就会自动找到`mail.example.com`邮件服务器

## 二、安装配置 Postfix

```shell
yum install -y postfix
```

主配置文件`/etc/postfix/main.cf`中的重要参数

| 参数            | 作用                     |
| --------------- | ------------------------ |
| myhostname      | 主机名                   |
| mydomain        | 根域名                   |
| myorigin        | 发出邮件的域             |
| inet_interfaces | 网卡监听地址             |
| destination     | 接收邮件的主机或域列表   |
| mynetworks      | 设置可转发哪些主机的邮件 |
| relay_domains   | 设置可转发哪些网域的邮件 |

设置成仅用于发送邮件

vim /etc/postfix/main.cf

```shell
myhostname = mail.example.com
mydomain = example.com
myorigin = $mydomain
inet_interfaces = localhost
inet_protocols = ipv4
mydestination = $myhostname, localhost.$mydomain, localhost
```

官方文档：

- [《Postfix Basic Configuration》](http://www.postfix.org/BASIC_CONFIGURATION_README.html)
- [《Postfix Standard Configuration Examples》](http://www.postfix.org/STANDARD_CONFIGURATION_README.html)

## 三、使用Sendcloud等扩展SMTP服务发送邮件

### 3.1. 安装

```shell
yum -y install postfix cyrus-sasl-plain mailx

systemctl enable --now postfix
```

### 3.2. Postfix 配置

vim /etc/postfix/main.cf

```plain
#relayhost = [smtp.gmail.com]:587
relayhost = [smtp587.sendcloud.net]:587

smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous
smtp_tls_security_level = encrypt
smtp_tls_wrappermode = yes
```

vim /etc/postfix/sasl_passwd

```plain
[smtp.gmail.com]:587 email@example.com:xxxxxxxx
[smtp587.sendcloud.net]:587 username:xxxxxxxx
```

SASL 凭证

```shell
postmap /etc/postfix/sasl_passwd
```

权限

```shell
chown root:root /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db && \
chmod 0600 /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db
```

### 3.3. 测试

```shell
systemctl restart postfix
```

方法1:

```shell
echo "Your message" | mail -s "Message Subject" me@wangyan.org
```

方法2:

```shell
sendmail user1@example.com

From: user2@example.com
To: user1@example.com
Subject: Test mail
This is a test email
.
```

测试

```
telnet smtp587.sendcloud.net 587
telnet smtp.sendcloud.net 2525
```

```shell
tail -f /var/log/maillog # 查看日志
```

参考：

- [《Configure Postfix to Send Mail Using an External SMTP Server》](https://www.linode.com/docs/email/postfix/postfix-smtp-debian7/)
- [《Configure Postfix to Send Mail Using Gmail and Google Apps on Debian or Ubuntu》](https://www.linode.com/docs/email/postfix/configure-postfix-to-send-mail-using-gmail-and-google-apps-on-debian-or-ubuntu/)
