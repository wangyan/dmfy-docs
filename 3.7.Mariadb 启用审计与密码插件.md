# Mariadb 启用审计与密码插件

## 一、开启审计

- [MariaDB Audit Plugin](https://mariadb.com/kb/en/mariadb/server_audit-system-variables/#server_audit_events)

### 1.1. 查看当前开启审计

```sql
show variables like '%audit%';
```
如果没有，则先查看审计插件目录

```sql
SHOW VARIABLES LIKE 'plugin_dir';
```

> /usr/lib64/mysql/plugin/
> /usr/lib64/mariadb/plugin/  (rhel8)

### 1.2. 启用审计

/etc/my.cnf.d/server_audit.cnf

```shell
[mariadb]
# MariaDB Audit Plugin
plugin-load-add=server_audit.so
server_audit=FORCE_PLUS_PERMANENT
server_audit_events=CONNECT,QUERY,TABLE
server_audit_logging=ON
server_audit_file_path=/var/log/mariadb/audit.log
```

### 1.3. 重启

```shell
#docker restart mariadb
systemctl restart mariadb
```

## 二、查询日志

<https://mariadb.com/kb/en/library/error-log/>

vim /etc/my.cnf.d/mariadb-logs.cnf

```shell
[mariadb]

# error log
log_error=/var/log/mariadb/mariadb.log
aria-log-dir-path=/var/log/mariadb/

# binary logging
log_bin=ON
log_basename=mariadb
binlog_format=mixed
expire_logs_days=365

## Slow Query Log
slow_query_log=1
slow_query_log_file=/var/log/mariadb/mariadb-slow.log
long_query_time=10
log_queries_not_using_indexes=ON
```

## 二、启用密码插件

[Password Validation Plugin API](https://mariadb.com/kb/en/library/password-validation/)

### 2.1. simple_password_check

[Simple Password Check Plugin](https://mariadb.com/kb/en/library/simple-password-check-plugin/)

方法一：

```bash
/usr/local/mysql/bin/mysql -uroot -p
MariaDB> INSTALL SONAME 'simple_password_check';
MariaDB> UNINSTALL SONAME 'simple_password_check';
```

方法一：

/etc/my.cnf.d/simple_password_check.cnf

```bash
[mariadb]
# Password Validation
plugin_load_add = simple_password_check.so
simple_password_check_digits=1
simple_password_check_letters_same_case=1
simple_password_check_minimal_length=8
simple_password_check_other_characters=1
```

### 2.2. cracklib_password_check

[Cracklib Password Check Plugin](https://mariadb.com/kb/en/library/cracklib-password-check-plugin/)

```shell
sudo yum install MariaDB-cracklib-password-check
```

安装

```sql
INSTALL SONAME 'cracklib_password_check';
```

配置

```shell
[mariadb]
...
plugin_load_add = cracklib_password_check
```

卸载

```shell
UNINSTALL SONAME 'cracklib_password_check';
```
