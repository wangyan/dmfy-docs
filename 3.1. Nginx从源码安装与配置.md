# RHEL/CentOS 从源码安装与配置 Nginx

## 一、准备

### 1.1. 下载软件包

```bash
mkdir ~/packages && cd ~/packages

wget -c https://www.openssl.org/source/openssl-1.0.2t.tar.gz && \
tar -zxf openssl-1.0.*.tar.gz -C /usr/local/src

wget -c https://www.openssl.org/source/openssl-1.1.1d.tar.gz && \
tar -zxf openssl-1.1.1*.tar.gz -C /usr/local/src

wget -c https://ftp.pcre.org/pub/pcre/pcre-8.43.tar.gz && \
tar -zxf pcre-*.tar.gz -C /usr/local/src

wget -c http://nginx.org/download/nginx-1.16.1.tar.gz && \
tar -zxf nginx-*.tar.gz -C /usr/local/src
```

### 1.2. 安装必须的依赖

```bash
#yum groupinstall 'Development Tools'
yum install -y gcc gcc-c++ zlib-devel
```

安装 Perl (可选)

<http://www.cpan.org/src/>

```bash
# rhel 8
wget https://www.cpan.org/src/5.0/perl-5.30.0.tar.gz && \
tar -xzf perl-5.30.0.tar.gz -C /usr/local/src && \
cd /usr/local/src/perl-5.30.0 && \
./Configure -des -Dprefix=/usr/local/perl && \
make && make install && \
perl -v
```

### 1.3. 新增用户和组

```bash
groupadd -g 96 nginx && \
useradd -c "Nginx web server" -d /usr/local/nginx -g 96 -M -s /sbin/nologin -u 96 nginx
```

## 二、安装

### 2.1. 编译安装

```bash
cd /usr/local/src/nginx-*

./configure \
    --prefix=/usr/local/nginx \
    --user=nginx  \
    --group=nginx  \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_realip_module \
    --with-http_sub_module \
    --with-http_gzip_static_module \
    --with-http_stub_status_module  \
    --with-openssl=/usr/local/src/openssl-1.1.1d \
    --with-pcre=/usr/local/src/pcre-8.43 \
    --http-client-body-temp-path=/usr/local/nginx/temp/client_body \
    --http-proxy-temp-path=/usr/local/nginx/temp/proxy \
    --http-fastcgi-temp-path=/usr/local/nginx/temp/fastcgi \
    --http-uwsgi-temp-path=/usr/local/nginx/temp/uwsgi \
    --http-scgi-temp-path=/usr/local/nginx/temp/scgi

make && make install
ln -s /usr/local/nginx/conf/ /etc/nginx
```

### 2.2. 配置环境变量

```bash
cat >>/etc/profile<<'EOF'

PATH=$PATH:/usr/local/mysql/bin:/usr/local/php/bin:/usr/local/nginx/sbin
export PATH
EOF

source /etc/profile
```

## 三、配置

### 3.1. 配置缓存

```bash
mkdir -p /usr/local/nginx/temp/{client_body,proxy,fastcgi,uwsgi,scgi} && \
chown -R nginx:nginx /usr/local/nginx/temp/
```

### 3.2. 其他配置

```bash
mkdir -p /usr/local/nginx/conf/{sites-available,sites-enabled,conf.d,rewrite-rules,ssl-certs} && \
chmod 711 /usr/local/nginx/conf/{sites-available,sites-enabled,conf.d,rewrite-rules,ssl-certs}

mv -f /usr/local/nginx/conf/nginx.conf /usr/local/nginx/conf/nginx.conf.bak && \
wget http://download.wangyan.org/conf/nginx/nginx.conf -P /usr/local/nginx/conf && \
wget http://download.wangyan.org/conf/nginx/default_server.conf -P /usr/local/nginx/conf/conf.d && \
wget http://download.wangyan.org/conf/nginx/{phpcms.conf,wordpress.conf} -P /usr/local/nginx/conf/rewrite-rules && \
chmod 644 -R /usr/local/nginx/conf/{nginx.conf,conf.d,rewrite-rules}

wget http://download.wangyan.org/conf/nginx/{400.html,403.html,404.html,500.html,502.html} -P /usr/local/nginx/html && \
chmod 644 /usr/local/nginx/html/*
```

### 3.3. 开机自启动

```bash
cat >/usr/lib/systemd/system/nginx.service<<'EOF'
[Unit]
Description=nginx - high performance web server
Documentation=http://nginx.org/en/docs/
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/run/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF
```

```bash
chmod +x /usr/lib/systemd/system/nginx.service && \
systemctl enable nginx.service && \
systemctl start nginx.service
```

### 3.4. 防火墙设置

```bash
systemctl enable firewalld.service && \
systemctl start firewalld.service

sudo firewall-cmd --permanent --zone=public --add-service=http && \
sudo firewall-cmd --permanent --zone=public --add-service=https && \
sudo firewall-cmd --reload
```

## 四、一键安装

> 过时，仅参考

```bash
wget http://download.wangyan.org/conf/nginx/nginx_setup_rhel.sh && \
chmod +x nginx_setup_rhel.sh && \
./nginx_setup_rhel.sh
```
