# Seafile 专业版安装配置

## 一、新建容器

### 1.1. Docker

```bash
# Ubuntu 18.04
docker run -it --name seafile \
--restart=always \
-v /home/seafile:/opt/dfcloud \
-p 8000:8000 \
-p 8082:8082 \
-p 8080:8080 \
-d phusion/baseimage:0.11 /sbin/my_init
```

### 1.2. podman

```bash
# Ubuntu 18.04
podman run -it --name dfcloud \
-v /home/dfcloud:/opt/dfcloud \
-p 8000:8000 \
-p 8082:8082 \
-p 8080:8080 \
-d phusion/baseimage:0.11 /sbin/my_init
```

进入容器

```bash
podman exec -it dfcloud /bin/bash
```

> docker 内不装 nginx ，所以没有 80 和 443 端口

### 1.3. 国内镜像源

```bash
# 网易镜像
sed -i 's/archive.ubuntu.com/mirrors.163.com/g' /etc/apt/sources.list

# 取消注释
sed -i 's/mirrors.163.com//archive.ubuntu.com/g' /etc/apt/sources.list

# 更新
apt -y update
```

### 1.4. 安装实用工具

```bash
apt install -y curl wget net-tools vim iputils-ping
```

## 二、安装 Seafile 依赖

[Download and Setup Seafile Professional Server](https://manual.seafile.com/deploy_pro/download_and_setup_seafile_professional_server.html)

### 2.1. 安装 python2.7

```shell
# ubuntu 18.04
apt update && \
apt -y install python && \
apt -y install python2.7 libpython2.7 python-setuptools python-pil \
                   python-ldap python-urllib3 ffmpeg python-pip python-mysqldb \
                   python-memcache python-requests
```

Python 库

```shell
#easy_install pip
pip install boto requests
```

### 2.2. 安装 JRE

```shell
apt -y install openjdk-8-jre && \
ln -sf /usr/lib/jvm/java-8-openjdk-amd64/jre/bin/java /usr/bin/
```

### 2.3. 安装 pdf 全文搜索依赖

```shell
apt -y install poppler-utils
```

### 2.4. 在线预览依赖

```shell
apt -y install libreoffice libreoffice-script-provider-python && \
apt -y install ttf-wqy-microhei ttf-wqy-zenhei xfonts-wqy && \
apt -y install poppler-utils
```

## 三、安装 Seafile 专业版

### 3.1. 下载 seafile pro

- 官方下载： <https://customer.seafile.com/downloads/>

安装目录 `/opt/dfcloud`

```shell
tar -xzf seafile-pro-server_*
mkdir installed
mv seafile-pro-server_* installed
cd seafile-pro-server-*
```

### 3.2. 安装 seafile pro

```shell
./setup-seafile-mysql.sh

# 配置信息
WYCloud
cloud.wangyan.org
/opt/dfcloud/seafile-data
8082
1
localhost
3306
seafile
seafile_ccnet
seafile_db
seafile_seahub
```

## 四、配置 Seafile 专业版

### 4.1. 基础设置

```shell
vim /opt/dfcloud/conf/ccnet.conf
SERVICE_URL = https://cloud.wangyan.org
```

```shell
vim /opt/dfcloud/conf/seahub_settings.py
FILE_SERVER_ROOT = 'https://cloud.wangyan.org/seafhttp'
```

### 4.2. WEBDAV

```shell
vim /opt/dfcloud/conf/seafdav.conf
[WEBDAV]
enabled = true
port = 8080
fastcgi = true
share_name = /seafdav
```

### 4.3. 在线预览

```shell
vim /opt/dfcloud/conf/seafevents.conf

[OFFICE CONVERTER]
enabled = true
```

### 4.4. 病毒扫描

安装 `clamav-daemon` 和 `clamav-freshclam`

```bash
apt install -y clamav-daemon clamav-freshclam
```

修改 clamd 配置文件，建议以 root 权限运行 clamd 进程：

```bash
vim /etc/clamav/clamd.conf

LocalSocketGroup root
User root
```

启动 `clamav-daemon`

```bash
freshclam
service clamav-daemon start
```

vim /etc/init.d/clamd

```bash
case "$1" in
  start)
    echo -n "Starting Clam AntiVirus Daemon... "
    /usr/sbin/clamd
    RETVAL=$?
    echo
    [ $RETVAL -eq 0 ] && touch /var/lock/subsys/clamd
    ;;
  stop)
    echo -n "Stopping Clam AntiVirus Daemon... "
    pkill clamd
    rm -f /var/run/clamav/clamd.sock
    rm -f /var/run/clamav/clamd.pid
    RETVAL=$?
    echo
    [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/clamd
    ;;
esac
```

```bash
chmod +x /etc/init.d/clamd
chkconfig clamd on
service clamd start
```

测试 Clamd 工作效果：

```bash
clamdscan /dir/PATH
```

修改 seafile 配置文件

```bash
vim seafile.conf:

[virus_scan]
scan_command = clamdscan
virus_code = 1
nonvirus_code = 0
scan_interval = 60
scan_size_limit = 100M
scan_skip_ext = .bmp, .gif, .ico, .png, .jpg, .mp3, .mp4, .wav, .avi, .rmvb, .mkv
threads = 10
```

### 4.5. 自定义CSS

```shell
mkdir /opt/dfcloud/seahub-data/custom
ln -s /home/dfcloud/seahub-data/custom /home/dfcloud/seafile-server-latest/seahub/media/custom
```

### 4.6. 时间同步

```shell
echo "Asia/Shanghai" > /etc/timezone && \
apt install -y tzdata && \
rm /etc/localtime && \
ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
dpkg-reconfigure -f noninteractive tzdata

# ntpdate
apt -y install ntpdate && \
ntpdate -d cn.pool.ntp.org
```

### 4.5. firewall 防火墙

```bash
cat >/etc/firewalld/services/seafile.xml<<-EOF
<?xml version="1.0" encoding="utf-8"?>
<service>
  <short>shadowsocks</short>
  <description>An open source cloud storage system with privacy protection and teamwork features.</description>
  <port protocol="tcp" port="8080"/>
  <port protocol="tcp" port="8000"/>
  <port protocol="tcp" port="8082"/>
</service>
EOF
```

重载

```bash
systemctl start firewalld && \
systemctl enable firewalld

systemctl stop firewalld
systemctl disable firewalld

firewall-cmd --set-default-zone=public

firewall-cmd --permanent --zone=public --add-service=seafile
firewall-cmd --permanent --zone=public --remove-service=seafile
firewall-cmd --zone=public --permanent --list-service
firewall-cmd --reload
firewall-cmd --complete-reload
```

## 五、其他

### 5.1. 运行

```shell
podman exec -it dfcloud /bin/bash
/opt/dfcloud/seafile-server-latest/seafile.sh start
/opt/dfcloud/seafile-server-latest/seahub.sh start
```

### 5.2. podman 自启动

vim /usr/lib/systemd/system/dfcloud.service

```shell
[Unit]
Description=Podman Seafile Service
After=network.target
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/podman start -a dfcloud
ExecStop=/usr/bin/podman stop -t 10 dfcloud
Restart=always

[Install]
WantedBy=multi-user.target
```

```shell
systemctl daemon-reload
systemctl enable dfcloud.service
systemctl start dfcloud.service
```

参考文档：

- [Setup Seafile Professional Server](https://manual.seafile.com/deploy_pro/download_and_setup_seafile_professional_server.html)
- [Deploying Seafile with MySQL](https://manual.seafile.com/deploy/using_mysql.html)
- [Config Seahub with Nginx](https://manual.seafile.com/deploy/deploy_with_nginx.html)
- [Enabling Https with Nginx](https://manual.seafile.com/deploy/https_with_nginx.html)
- [WebDAV extension](https://manual.seafile.com/extension/webdav.html)
- [Seafile服务器手册中文版](https://manual-cn.seafile.com/)
