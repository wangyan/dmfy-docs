# RHEL/CentOS 系统安全策略

##  一、密码安全策略

### 1.1. 设置密码复杂度

> 红帽企业版 Linux 7 中， pam_pwquality PAM 模块已取代了旧的 pam_cracklib 模块。

#### 1.1.1. 启用 pam_pwquality 模块

检查是否安装了 pam_pwquality 模块

```bash
rpm -qa | grep pwquality

libpwquality-1.2.3-5.el7.x86_64
```

在 /etc/pam.d/passwd 文件下的 password 区域添加：

```bash
# 如果用户输入的密码强度不够可以重复输入的次数，默认值是 1，一般设置为 3。
password   required     pam_pwquality.so retry=3
```

#### 1.1.2. 定义密码强度规则

```bash
vim /etc/security/pwquality.conf
```

配置选项：

```bash
difok = 4
minlen = 8
dcredit = -1
ucredit = -1
lcredit = -1
ocredit = -1
minclass = 4
maxrepeat = 3
maxclassrepeat = 3
gecoscheck = 1
```

参数说明：

| 参数             | 说明                                                             |
|------------------|------------------------------------------------------------------|
| difok=M          | 新密码与前一个旧密码之间至少有 M 个字符不相同                    |
| minlen=N         | 密码最小长度                                                     |
| dcredit=N        | 密码中至少有几个数字（至少 N<0 或至多 N>=0）                     |
| ucredit=N        | 密码中至少有几个大写字母（至少 N<0 或至多 N>=0）                 |
| lcredit=N        | 密码中至少有几个小写字母（至少 N<0 或至多 N>=0）                 |
| ocredit=N        | 密码中至少有几个特殊字符（至少 N<0 或至多 N>=0）                 |
| minclass=N       | 密码要包含全部四种字符（数字、大、小写、特殊字符）               |
| maxrepeat=N      | 新密码中允许的最大连续相同字符数                                 |
| maxclassrepeat=N | 完全相同的连续字符也不能超过 N 个                                |
| gecoscheck=N     | 检查passwd条目的GECOS字段的长度超过3个字符的字是否包含在新密码中 |

> 注：由于root 用户是施行密码创建规则的人，尽管有出现警告消息，他也能够为自己或普通用户设置任何密码。

#### 1.1.3. 使用 cracklib 模块（旧）

检查是否安装了 pam_cracklib 模块

```bash
rpm -qa | grep cracklib

#cracklib-2.9.0-11.el7.x86_64
#cracklib-dicts-2.9.0-11.el7.x86_64
```

添加 cracklib 规则：

```bash
vim /etc/pam.d/system-auth

# 密码强度规则
password    requisite     pam_cracklib.so try_first_pass retry=3 difok=3 minlen=8 dcredit=-1 ucredit=-1 lcredit=-1 ocredit=-1

# 防止用户再次使用以前使用过的密码 remember=3（3次）
password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok remember=3
```

### 1.2. 设置密码有效期

#### 1.2.1. 针对已经存在的用户

目前系统已经存在的用户，则直接用 chage 来配置规则

```bash
# 密码90天有效期
chage -M 90 <username>

# 立即到期
chage -d 0 <username>
```

选项：

> -m：密码可更改的最小天数。为零时代表任何时候都可以更改密码。
> -M：密码保持有效的最大天数。
> -W：用户密码到期前，提前收到警告信息的天数。
> -E：帐号到期的日期。过了这天，此帐号将不可用。
> -d：上一次更改的日期。
> -I：密码失效后保留天数。如果密码已过期这些天，那么此帐号将不可用。
> -l：列出该帐号当前的密码策略。


查看密码情况

```bash
chage -M 90 -W 7 -I 7 <username>
chage -l <username>
```

> 最近密码修改时间               : Feb 23, 2019
> 密码过期时间				         	: May 24, 2019
> 密码失效时间			         		: May 31, 2019
> 帐户过期时间			        		: never
> 两次改变密码之间相距的最小天数   : 0
> 两次改变密码之间相距的最大天数   : 90
> 在密码过期之前警告的天数	      ：7

#### 1.2.2. 针对之后新建的用户

通过修改全局配置文件，能对之后新建用户起作用

```bash
vim /etc/login.defs

PASS_MAX_DAYS   90
PASS_MIN_DAYS   0
PASS_MIN_LEN    8
PASS_WARN_AGE   7
```

##  二、锁定未激活的账户

### 2.1. 登录失败后锁定账户

`pam_faillock` PAM 模块允许系统管理员锁定在指定次数内登录尝试失败的用户账户。

> 提示：通过 pam_faillock 模块，将登录尝试失败的数据储存在 /var/run/faillock 目录下每位用户的独立文件中。

在三次失败尝试后，对任何非 root 用户进行锁定，并在十分钟后对该用户解锁

```bash
vim /etc/pam.d/system-auth
vim /etc/pam.d/password-auth
```

1）在 auth 区域添加：

```bash
auth        required       pam_faillock.so preauth silent audit deny=6 unlock_time=600
auth        sufficient     pam_unix.so nullok try_first_pass
auth        [default=die]  pam_faillock.so authfail audit deny=6 unlock_time=600
```

2）在 account 区域添加：

```bash
account     required      pam_faillock.so
```

3）让账户锁定也适用于 root 用户

在 system-auth 和 password-auth 文件中的 pam_faillock 条目里添加 `even_deny_root` 选项：

```bash
auth        required      pam_faillock.so preauth silent audit deny=6 even_deny_root unlock_time=600
auth        sufficient    pam_unix.so nullok try_first_pass
auth        [default=die] pam_faillock.so authfail audit deny=6 even_deny_root unlock_time=600
auth        sufficient    pam_faillock.so authsucc audit deny=6 even_deny_root unlock_time=600
```

4）例外情况

要让一个用户即使在数次登录失败之后，其账户仍未被锁定，则须在 system-auth 和 password-auth 文件中的 "first call of" pam_faillock 之前添加以下命令行。也可以用 user1, user2, user3 代替实际用户名。

```bash
auth        [success=1 default=ignore] pam_succeed_if.so user in dmfy
```

5）查看每个用户的尝试失败次数

```bash
faillock
```

### 2.2. 使用 authconfig 锁定账户

当使用 authconfig 功能对验证配置参数进行修改时， authconfig 功能的设置参数会覆盖 system-auth 文件和 password-auth 文件。要同时使用配置文件和 authconfig ，您必须使用以下步骤对账户锁定进行参数配置：

1）创建以下符号链接：

```bash
ln -s /etc/pam.d/system-auth /etc/pam.d/system-auth-local
ln -s /etc/pam.d/password-auth /etc/pam.d/password-auth-local
```

2）/etc/pam.d/system-auth-local 文件应含有以下命令行：

```bash
auth        required       pam_faillock.so preauth silent audit deny=3 unlock_time=600 include system-auth-ac
auth        [default=die]  pam_faillock.so authfail silent audit deny=3 unlock_time=600

account     required       pam_faillock.so
account     include        system-auth-ac

password    include        system-auth-ac

session     include        system-auth-ac
```

3）/etc/pam.d/password-auth-local 文件应含有以下命令行：

```bash
auth        required       pam_faillock.so preauth silent audit deny=3 unlock_time=600 include password-auth-ac
auth        [default=die]  pam_faillock.so authfail silent audit deny=3 unlock_time=600

account     required       pam_faillock.so
account     include        password-auth-ac

password    include        system-auth-ac

session     include        system-auth-ac
```

### 2.3. 使用 vlock 锁定虚拟控制台

```bash
yum install vlock

vlock # 锁定当前虚拟控制台
vlock -a # 锁定所有虚拟控制台
```

### 2.4. 账户登录限制

1）配置用户最大登录数

```bash
vim /etc/security/limits.conf

root – maxlogins 3
dmfy – maxlogins 3
wangyan – maxlogins 3
sysadmin – maxlogins 3
safeadmin – maxlogins 3
safecheck – maxlogins 3
```

2）登录超时

```bash
vim /etc/profile
export TMOUT=600
readonly TMOUT
```

3）避免普通用户 su 到 root 用户(选做)

```bash
vim /etc/pam.d/su

auth            sufficient      pam_rootok.so debug
auth            required        pam_wheel.so group=wheel
```

##  三、OpenSSH 安全

### 3.1. 使用 PAM 模块

```bash
#cp contrib/redhat/sshd.pam /etc/pam.d/sshd
cp contrib/sshd.pam.generic /etc/pam.d/sshd

vim /etc/ssh/sshd_config
UsePAM yes
```

失败3次后需要3分钟才解锁（普通）、5分钟（root）

```bash
vim /etc/pam.d/system-auth
vim /etc/pam.d/sshd #第1行
```

```bash
auth       required     pam_tally2.so deny=3 unlock_time=180 even_deny_root root_unlock_time=300
```

30分钟后才解锁

```bash
vim /etc/pam.d/login #第1行
```

```bash
auth       required     pam_tally2.so deny=3 unlock_time=1800 even_deny_root root_unlock_time=1800
```

### 3.2. Fail2Ban 防止暴力破解

```bash
#安装
yum update && yum install epel-release
yum -y install fail2ban && \
systemctl start fail2ban && \
systemctl enable fail2ban

#配置
cp /etc/fail2ban/fail2ban.conf /etc/fail2ban/fail2ban.local && \
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

vim /etc/fail2ban/jail.local
ignoreip = 127.0.0.1/8  192.168.0.0/16
bantime  = 3600
backend = systemd
destemail = wangyan@188.com
sender = noreply@dm.mail.wangyan.org
mta = mail
[sshd]
enabled = true
[sshd-ddos]
enabled = true

#重启
systemctl restart fail2ban
#查询fail2ban服务状态：
fail2ban-client status
#查询某个jail的详细信息：
fail2ban-client status sshd
#最近一次启动，fail2ban日志：
journalctl -b -u fail2ban

#添加黑名单
fail2ban-client set sshd banip 129.168.1.1
#移除黑名单
fail2ban-client set sshd unbanip 129.168.1.1

#传统方法
vim /etc/hosts.allow
vim /etc/hosts.deny
```

<https://www.linode.com/docs/security/using-fail2ban-for-security>

### 3.3. 其他

```bash
vim /etc/ssh/sshd_config

# 禁止 root 远程登录
PermitRootLogin no
```

##  四、其他

1）设置umask为022；

2）禁用多余服务，
如：bluetooth、cups、netfs、nfslock、telnet、rlogin（可选）、ftp（可选）sendmail（可选）、snmpd（可选）等；

3）设置权限

```bash
chmod 400 /etc/rsyslog.conf
chmod 640 /etc/crontab

恢复原来权限
chmod 644 /etc/rsyslog.conf
chmod 644 /etc/crontab
```

4）禁止用户挂载移动设备：

```shell
vim /etc/security/console.perms
#<console> ……
```

文档：

- [security_guide](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/)
