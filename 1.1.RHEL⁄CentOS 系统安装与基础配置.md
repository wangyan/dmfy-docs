# RHEL⁄CentOS 系统安装与基础配置

## 一、系统分区

### 1.1. 划分 LVM 分区

使用 fdisk 创建分区

```bash
fdisk /dev/sdb
```

1. n：创建一个新的分区
2. p：创建主分区
3. t：将分区类型从 linux (0x83) 改成 LVM (0x8e)
4. l：列出所有分区类型代码
5. w：保存更改

创建 LVM 分区

```bash
pvcreate /dev/sdb1 #物理分区
vgcreate data /dev/sdb1 #LVM组
lvcreate -n home -l 100%FREE data #创建LVM逻辑分区
mkfs.xfs /dev/data/home #格式化
```

其他 LVM 命令：

```bash
lvm  # 进入lvm环境

lvm> pvs -v # 查看物理卷
lvm> vgs -v # 查看卷组
lvm> lvs -v # 查看逻辑卷

# 修改卷组
vgrename WYCkqz-EWWd-nJ1x-5RPm-Sj60-RBeN-CO2oZm centos

# 查看修改结果
vgs -v
lvscan

# 激活
vgchange -ay /dev/centos
```

参考资料：

- <http://xstarcd.github.io/wiki/Linux/lvm.html>
- <https://man.linuxde.net/lvcreate>

### 1.2. 设置 Linux Swap 空间（可选）

生成 swapfile

```bash
# M=Mebibytes, G=Gibibytes
# dd if=/dev/zero of=/swapfile bs=1M count=2048
fallocate -l 2G /swapfile
```

启用 swapfile

```bash
# 权限
chmod 600 /swapfile

# 格式化
mkswap /swapfile

# 启用指定 swapfile
swapon /swapfile

# 开机启用
vi /etc/fstab
/swapfile swap swap defaults 0 0

# 手动启用所有
mount -a
swapon -a
```

Swap 策略

```bash
# 策略，物理内存不足时启用
sysctl -w vm.swappiness=10
echo vm.swappiness = 10 | tee -a /etc/sysctl.conf

sysctl vm.vfs_cache_pressure=60
echo vm.vfs_cache_pressure = 60 | tee -a /etc/sysctl.conf
```

其他命令

```bash
# 状态
swapon -s
free -m

# 设备UUID
lsblk -no UUID /dev/xxx
```

## 二、系统设置

### 2.1. SSH 证书配置

生成证书

```bash
ssh-keygen -t rsa -b 4096 -C "dmfy-wangyan"
mkdir ~/.ssh; vi ~/.ssh/authorized_keys
chmod 700 -R ~/.ssh && chmod 400 ~/.ssh/authorized_keys
```

禁用密码登录

```bash
vi /etc/ssh/sshd_config

PermitRootLogin no
PasswordAuthentication no
KerberosAuthentication no
GSSAPIAuthentication no
```

重启

```bash
#systemctl restart sshd.socket
systemctl restart sshd.socket
```

### 2.2. 修改主机名

```bash
hostnamectl status
hostnamectl set-hostname dmfy.gov.cn
```

### 2.3. 不升级内核、系统

```bash
# 当前内核
# Linux 3.10.0-514.el7.x86_64
uname -rs

# 发行版
#CentOS Linux release 7.3.1611 (Core)
cat /etc/centos-release

# 排除内核和系统版本更新
vim /etc/yum.conf
exclude=kernel* centos-release* redhat-release*
```

### 2.3. 禁用/启用防火墙

```bash
systemctl stop firewalld.service && \
systemctl disable firewalld.service

systemctl enable firewalld.service && \
systemctl restart firewalld.service
```

### 2.4. 时间日期配置

#### 2.4.1. 方法一：使用 ntpd 同步时间

```bash
# 安装ntp
yum install ntp -y && \
systemctl enable ntpd.service && \
systemctl start ntpd.service

#设置时区
timedatectl set-timezone Asia/Shanghai && \
timedatectl set-ntp yes && \
```

#### 2.4.2. 方法二：使用 chronyd 同步时间

```bash
# 开机启用
systemctl enable --now chronyd

# 备份
cp /etc/chrony.conf /etc/chrony.conf.bak
```

配置文件：

```bash
cat >/etc/chrony.conf <<-EOF
server ntp.aliyun.com iburst
stratumweight 0
driftfile /var/lib/chrony/drift
rtcsync
makestep 10 3
bindcmdaddress 127.0.0.1
bindcmdaddress ::1
keyfile /etc/chrony.keys
commandkey 1
generatecommandkey
logchange 0.5
logdir /var/log/chrony
EOF
```

时区设置

```bash
systemctl restart chronyd
timedatectl set-timezone Asia/Shanghai
netstat -tulpn
```

### 2.5. 禁用 SELinux

```bash
vim /etc/selinux/config

SELINUX=disabled
```

### 2.6. 修改最大文件限制数 ulimit

避免 too many open files 错误

```bash
# bash 级限制
ulimit -n 1000000
```

vim /etc/security/limits.conf

```bash
# 用户级限制
* hard nofile 1000000
* soft nofile 1000000
* soft core unlimited
* soft stack 10240
```

vim /proc/sys/fs/file-max

```bash
# 系统级限制
cat /proc/sys/fs/file-max
```

### 2.7. 设置系统默认语言

```bash
localectl set-locale LANG=en_US.utf8
```

### 2.8. 关闭不需要的服务

```bash
netstat -tulpn # 查看
yum remove package_name # 删除
```

## 三、网络设置

### 3.1. 使用静态IP

备份配置文件

```bash
# RHEL 7
cp /etc/sysconfig/network-scripts/ifcfg-em1 \
   /etc/sysconfig/network-scripts/ifcfg-em1.bak

# RHEL 8
cp /etc/sysconfig/network-scripts/ifcfg-eno1 \
   /etc/sysconfig/network-scripts/ifcfg-eno1.bak
```

读取 UUID

```bash
sed -n '/UUID/'p /etc/sysconfig/network-scripts/ifcfg-eno1
```

> 注意：下面的 IP GATEWAY UUID 都要修改

RHEL 7

```bash
cat >/etc/sysconfig/network-scripts/ifcfg-ens32<<-EOF
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
NAME=ens32
DEVICE=ens32
ONBOOT=yes
IPADDR=172.31.250.1
PREFIX=24
NETMASK=172.31.250.254
GATEWAY=192.168.10.1
PEERDNS=no
DNS1=114.114.114.114
EOF
```

RHEL 8

```bash
cat >/etc/sysconfig/network-scripts/ifcfg-eno1<<-EOF
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
NAME=eno1
UUID=2feb14ad-d70f-4473-8beb-683ba7dfdead
DEVICE=eno1
ONBOOT=yes
IPADDR=192.168.10.245
PREFIX=24
NETMASK=255.255.255.0
GATEWAY=192.168.10.1
PEERDNS=no
DNS1=114.114.114.114
EOF
```

### 3.2. 使用 nmcli 管理网络

```bash
# 查看网卡信息
nmcli connection
# 显示所有活动连接
nmcli connection show --active

# 修改主IP
nmcli connection modify eno1 ipv4.addresses 192.168.10.245
# 添加一个ipv4
nmcli connection modify eno1 +ipv4.addresses 192.168.10.251/24
# 删除一个ipv4
nmcli connection modify eno1 -ipv4.addresses 192.168.10.251/24

# 修改主DNS
nmcli connection modify eno1 ipv4.dns 114.114.114.114
nmcli connection modify eno1 +ipv4.dns 114.114.115.115

# 使用nmcli重新回载网络配置
nmcli c reload
nmcli c up eno1

# 删除网卡连接
nmcli connection delete eno1
# 添加网卡
nmcli connection add type ethernet con-name eno1

# 图形化工具
nmtui
```

### 3.3. 禁用IPV6（选做）

临时禁用

```bash
sysctl -w net.ipv6.conf.all.disable_ipv6=1.
sysctl -w net.ipv6.conf.default.disable_ipv6=1.
```

CentOS 7

```bash
vi /etc/sysctl.conf

# Disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

sysctl -p
```

Red Hat Enterprise Linux 7

```bash
cat >>/usr/lib/sysctl.d/50-default.conf<<-EOF

# Disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
EOF
```

生效

```bash
sysctl -p
```
