# RHEL/CentOS 配置 DNF/YUM 软件源

## 一、RHEL 7 配置 Yum 源

### 1.1. RHEL 官方订阅源

```bash
subscription-manager register --username=XX  --password=XX  --auto-attach
subscription-manager --list
yum update
```

### 1.2. 查询已安装的 yum 软件包

```bash
rpm -qa |grep yum
```

- yum-3.4.3-161.el7.noarch
- yum-rhn-plugin-2.0.1-10.el7.noarch
- yum-metadata-parser-1.1.4-10.el7.x86_64


### 1.3. 删除已安装的 yum 软件包

```bash
# args可以将输入内容（通常通过命令行管道传递），转成后续命令的参数
# -I '{}'表示将后面命令行的{}替换成前面解析出来的参数
rpm -aq|grep yum|xargs -t -I '{}' rpm -e {} --nodeps
rpm -qa |grep yum
```

- rpm -e yum-3.4.3-161.el7.noarch --nodeps
- rpm -e yum-rhn-plugin-2.0.1-10.el7.noarch --nodeps
- rpm -e yum-metadata-parser-1.1.4-10.el7.x86_64 --nodeps

### 1.4. 备份原有 yum 配置

```bash
whereis yum
mv /etc/yum /etc/yum.rhel
```

### 1.5. 安装新的 yum 软件包

<http://mirrors.163.com/centos/7/os/x86_64/Packages/>

> 根据实际需要安装，版本可能会失效

```bash
#导入证书
rpm --import http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

#安装
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-3.4.3-163.el7.centos.noarch.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-cron-3.4.3-163.el7.centos.noarch.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-utils-1.1.31-52.el7.noarch.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-52.el7.noarch.rpm

# 可能需要安装的依赖
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/python-urlgrabber-3.10-9.el7.noarch.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/rpm-4.11.3-40.el7.x86_64.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/python-chardet-2.2.1-3.el7.noarch.rpm
rpm -ivh http://mirrors.163.com/centos/7/os/x86_64/Packages/python-kitchen-1.1.1-5.el7.noarch.rpm
```

配置

```bash
touch /etc/yum/pluginconf.d/{product-id.conf,search-disabled-repos.conf,subscription-manager.conf}
```

### 1.6. 使用 163 源

```bash
cat >/etc/yum.repos.d/CentOS7-Base-163.repo<<'EOF'
[base]
name=CentOS-7 - Base - 163.com
baseurl=http://mirrors.163.com/centos/7/os/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[updates]
name=CentOS-7 - Updates - 163.com
baseurl=http://mirrors.163.com/centos/7/updates/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[extras]
name=CentOS-7 - Extras - 163.com
baseurl=http://mirrors.163.com/centos/7/extras/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[centosplus]
name=CentOS-7 - Plus - 163.com
baseurl=http://mirrors.163.com/centos/7/centosplus/$basearch/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7
EOF
```

或者直接下载

```bash
curl -o /etc/yum.repos.d/CentOS7-Base-163.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo
echo "7" > /etc/yum/vars/releasever
#sed -i "s|\$releasever|7|i" /etc/yum.repos.d/CentOS7-Base-163.repo
```

## 二、CentOS 7 配置 Yum 源

### 2.1. 备份

```bash
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
```

### 2.2. 使用 163 源

```bash
cat >/etc/yum.repos.d/CentOS7-Base-163.repo<<'EOF'
[base]
name=CentOS-$releasever - Base - 163.com
baseurl=http://mirrors.163.com/centos/$releasever/os/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[updates]
name=CentOS-$releasever - Updates - 163.com
baseurl=http://mirrors.163.com/centos/$releasever/updates/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[extras]
name=CentOS-$releasever - Extras - 163.com
baseurl=http://mirrors.163.com/centos/$releasever/extras/$basearch/
gpgcheck=1
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7

[centosplus]
name=CentOS-$releasever - Plus - 163.com
baseurl=http://mirrors.163.com/centos/$releasever/centosplus/$basearch/
gpgcheck=1
enabled=0
gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7
EOF
```

### 2.3. 添加 epel 源

```bash
yum install -y epel-release
```

或者

```bash
rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
```

生成缓存

```bash
yum clean all && yum makecache
```

## 三、CentOS 8 配置 DNF 源

修改配置文件

```bash
:%s#http://mirror.centos.org#https://mirrors.163.com#g
```

## 四、CentOS7 自动更新

### 4.1. 安装

```bash
yum install yum-cron -y
```

### 4.2. 配

```bash
vim /etc/yum/yum-cron.conf
download_updates = yes
apply_updates = yes
```

### 4.3. 开启服务

```bash
systemctl enable yum-cron.service
```

### 4.4. 运行服务

```bash
systemctl start  yum-cron
systemctl status yum-cron.service
```

### 4.5. 检查日志

```bash
grep yum.cron /var/log/cron | tail -10
```
