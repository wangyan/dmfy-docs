# Pure-ftp 安装与配置

## 一、安装

### 1.1. 安装依赖

```bash
#centos
#yum groupinstall "Development Tools"
yum -y install make gcc gcc-c++ gcc-g77 openssl openssl-devel bzip2 wget
yum -y install mariadb-devel

#ubuntu
apt-get --no-install-recommends install -y build-essential gcc g++ make openssl libssl-dev bzip2 wget;
```

### 1.2. 下载 pure-ftpd

```bash
wget -c https://download.pureftpd.org/pub/pure-ftpd/releases/pure-ftpd-1.0.49.tar.gz &&\
tar -zxf pure-ftpd-*.tar.gz && \
cd pure-ftpd-*/
```

### 1.3. 编译安装 pure-ftpd

<https://download.pureftpd.org/pub/pure-ftpd/doc/README>

```bash
./configure --prefix=/usr/local/pureftpd \
  --with-altlog \
  --with-tls \
  --with-certfile=/etc/ssl/private/pure-ftpd.pem \
  --with-cookie \
  --with-diraliases \
  --with-ftpwho \
  --with-mysql \
  --with-language=english \
  --with-paranoidmsg \
  --with-peruserlimits \
  --with-puredb \
  --with-quotas \
  --with-ratios \
  --with-sysquotas \
  --with-throttling  \
  --with-uploadscript \
  --with-virtualchroot \
  --with-virtualhosts \
  --with-welcomemsg \
  --with-bonjour \
  --with-implicittls \
  --with-rfc2640
make install-strip
```

## 二、配置

### 2.1. 配置文件

```bash
touch /usr/local/pureftpd/etc/pureftpd.passwd & \
touch /usr/local/pureftpd/etc/pureftpd.pdb

cp conf/pure-ftpd.conf /usr/local/pureftpd/etc/pure-ftpd.conf & \
cp conf/pureftpd-mysql.conf /usr/local/pureftpd/etc/pureftpd-mysql.conf
```

vim /usr/local/pureftpd/etc/pure-ftpd.conf

```bash
cat > /usr/local/pureftpd/etc/pure-ftpd.conf <<-EOF
  ChrootEveryone               no
  BrokenClientsCompatibility   yes
MaxClientsNumber             50
Daemonize                    yes
MaxClientsPerIP              8
VerboseLog                   no
DisplayDotFiles              yes
AnonymousOnly                no
  NoAnonymous                  yes
SyslogFacility               ftp
  DontResolve                  no
MaxIdleTime                  15
#MySQLConfigFile              /usr/local/pureftpd/etc/pureftpd-mysql.conf
  PureDB                       /usr/local/pureftpd/etc/pureftpd.pdb
LimitRecursion               10000 8
AnonymousCanCreateDirs       no
MaxLoad                      4
  PassivePortRange             30000 50000
AntiWarez                    yes
Umask                        133:022
MinUID                       100
AllowUserFXP                 no
AllowAnonymousFXP            no
ProhibitDotFilesWrite        no
ProhibitDotFilesRead         no
AutoRename                   no
  AnonymousCantUpload          yes
  NoChmod                      no
  AltLog                       w3c:/var/log/pureftpd.log
  CreateHomeDir                yes
PIDFile                      /var/run/pure-ftpd.pid
MaxDiskUsage                 99
  NoRename                     no
CustomerProof                yes
TLS                          1
CertFile                     /etc/ssl/private/pure-ftpd.pem
IPV4Only                     yes
EOF
```

### 2.2. 虚拟账号

```bash
groupadd -g 2000 ftpgroup
useradd -u 2000 -s /bin/false -d /bin/null -c "Pureftpd user" -g ftpgroup ftpuser

mkdir -p /home/ftpuser/wangyan
chown 2000:2000 /home/ftpuser -R

# wangyan 是虚拟用户,这个用户必须属于系统某个用户(ftpuser)，即wangyan拥有ftpuser权限
# /usr/local/pureftpd/etc/pureftpd.passwd
# /usr/local/pureftpd/etc/pureftpd.pdb
pure-pw useradd wangyan -u ftpuser -d /home/ftpuser/wangyan
pure-pw mkdb
```

其他命令：

```bash
pure-pw useradd 添加用户
pure-pw userdel 删除用户
pure-pw usermod 修改用户
pure-pw show 查看用户详细信息
pure-pw list 查看所有用户设置
pure-pw mkdb 生成数据文件
```

自动化脚本

```bash
#!/bin/bash
read -p '添加一个描述:' comment
read -p '指定工作目录:' directory
user=$(tr -cd [a-z][A-Z][0-9] </dev/urandom | head -c 6)
passwd=$(tr -cd [a-z][A-Z][0-9] </dev/urandom | head -c 16)
(echo $passwd;echo $passwd) | pure-pw useradd $user -u ftpuser -d directory
pure-pw mkdb

echo '---------------------------' >> ./ftp_useradd.log
echo '创建时间:' `date +%Y-%m-%d_%H:%M:%S` >> ./ftp_useradd.log
echo '描述:' $comment >> ./ftp_useradd.log
echo '用户:' $user >> ./ftp_useradd.log
echo '密码': $passwd >> ./ftp_useradd.log
echo '' >> ./ftp_useradd.log
echo '' >> ./ftp_useradd.log
```

### 2.3. 数据库账户

```sql
CREATE DATABASE pureftpd;
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP ON pureftpd.* TO 'ftpduser'@'localhost' IDENTIFIED BY 'ftpdpass';
FLUSH PRIVILEGES;
```

导入数据

```sql
CREATE TABLE `users` (
  `ID` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Name` varchar(16) DEFAULT NULL,
  `Sex` varchar(2) DEFAULT NULL,
  `Group` varchar(32) DEFAULT NULL,
  `User` varchar(16) NOT NULL,
  `Password` varchar(32) NOT NULL,
  `Uid` int(10) NOT NULL DEFAULT 2000,
  `Gid` int(10) NOT NULL DEFAULT 2000,
  `Dir` varchar(128) NOT NULL,
  `QuotaFiles` int(10) NOT NULL DEFAULT -1,
  `QuotaSize` int(10) NOT NULL DEFAULT -1,
  `ULRatio` smallint(5) NOT NULL DEFAULT -1,
  `DLRatio` smallint(5) NOT NULL DEFAULT -1,
  `ULBandwidth` int(10) NOT NULL DEFAULT -1,
  `DLBandwidth` int(10) NOT NULL DEFAULT -1,
  `IPAddress` varchar(15) NOT NULL DEFAULT '*',
  `Status` enum('0','1') NOT NULL DEFAULT '1',
  PRIMARY KEY (`ID`),
  UNIQUE KEY `User_UNIQUE` (`User`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

插入数据

```sql
INSERT INTO `users` (`User`, `Password`, `Uid`, `Gid`, `Dir`, `QuotaFiles`, `QuotaSize`, `ULRatio`, `DLRatio`, `ULBandwidth`, `DLBandwidth`, `IPAddress`, `Status`) VALUES ('ftpduser', 'ftpdpass', '2000', '2000', '/home/ftpuser', '-1', '1024', '-1', '-1', '-1', '-1', '*','1');
```

vim /usr/local/pureftpd/etc/pureftpd-mysql.conf

```sql
cat >/usr/local/pureftpd/etc/pureftpd-mysql.conf<<-EOF
MYSQLServer     localhost
MYSQLPort       3306
MYSQLSocket     /var/lib/mysql/mysql.sock
MYSQLUser       ftpduser
MYSQLPassword   ftpdpass
MYSQLDatabase   pureftpd
MYSQLCrypt      cleartext
MYSQLGetPW      SELECT Password FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MYSQLGetUID     SELECT Uid FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MYSQLGetGID     SELECT Gid FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MYSQLGetDir     SELECT Dir FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetQTAFS   SELECT QuotaFiles FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetQTASZ   SELECT QuotaSize FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetRatioUL SELECT ULRatio FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetRatioDL SELECT DLRatio FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetBandwidthUL SELECT ULBandwidth FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
MySQLGetBandwidthDL SELECT DLBandwidth FROM users WHERE User='\L' AND (IPAddress = "*" OR IPAddress LIKE "\R") AND Status="1"
EOF
```

### 2.4. PURE-FTP OVER TLS

```bash
mkdir -p /etc/ssl/private/

#custom
openssl req -x509 -nodes -days 7200 -newkey rsa:2048 -keyout /etc/ssl/private/pure-ftpd.pem -out /etc/ssl/private/pure-ftpd.pem
chmod 600 /etc/ssl/private/pure-ftpd.pem

#wangyan
cat /etc/nginx/ssl-certs/wangyan.org/wangyan.org.key > /etc/ssl/private/pure-ftpd.pem
cat /etc/nginx/ssl-certs/wangyan.org/fullchain.cer >> /etc/ssl/private/pure-ftpd.pem

chmod 600 /etc/ssl/private/*.pem
```

## 三、启动

### 3.1. 自启动

```bash
cat > /usr/lib/systemd/system/pure-ftpd.service <<-EOF
# pure-ftpd binary startup for DirectAdmin servers
# To reload systemd daemon after changes to this file:
# systemctl --system daemon-reload
[Unit]
Description=Pure-FTPd FTP server
After=syslog.target network.target

[Service]
Type=forking
ExecStart=/usr/local/pureftpd/sbin/pure-ftpd /usr/local/pureftpd/etc/pure-ftpd.conf

[Install]
WantedBy=multi-user.target
EOF
```

运行

```bash
chmod +x /usr/lib/systemd/system/pure-ftpd.service & \
systemctl enable pure-ftpd.service & \
systemctl start pure-ftpd.service
```

### 3.2. 手动启动

```bash
pkill -x pure-ftpd && /usr/local/pureftpd/sbin/pure-ftpd /usr/local/pureftpd/etc/pure-ftpd.conf
```
