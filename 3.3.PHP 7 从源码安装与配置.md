# RHEL/CentOS 从源码安装与配置 PHP 7.4

## 一、安装依赖

### 1.1. 安装编译工具及依赖

```bash
#yum groupinstall 'Development Tools'

# centos 7
yum install -y libsq3-devel

yum install -y \
    gcc gcc-c++ autoconf \
    systemd-devel openssl-devel libcurl-devel \
    oniguruma-devel zlib-devel \
    libwebp-devel libjpeg-turbo-devel freetype-devel libpng-devel \
    libxml2-devel libxslt-devel

# centos 8
yum install -y libsq-devel libzip-devel
```

### 1.2. 安装 libzip （选做）

#### 1.2.1. 通过 RPM 安装

<https://pkgs.org/download/libzip>

```shell
yum remove -y libzip
rpm -Uvh http://rpms.remirepo.net/enterprise/7/remi/x86_64//libzip-last-1.1.3-1.el7.remi.x86_64.rpm
rpm -Uvh http://rpms.remirepo.net/enterprise/7/remi/x86_64//libzip-last-devel-1.1.3-1.el7.remi.x86_64.rpm
```

#### 1.2.2. 手动编译安装

1. 安装 cmake

```shell
wget https://cmake.org/files/v3.16/cmake-3.16.0-Linux-x86_64.sh &&\
mkdir /usr/local/cmake &&\
mv cmake-3.16.0-Linux-x86_64.sh /usr/local/cmake &&\
chmod +x /usr/local/cmake/cmake-3.16.0-Linux-x86_64.sh  &&\
cd /usr/local/cmake &&\
./cmake-3.16.0-Linux-x86_64.sh
ln -s /usr/local/cmake/bin/cmake /usr/local/bin/cmake
```

2. 编译安装 libzip*

```shell
wget https://libzip.org/download/libzip-1.5.2.tar.gz &&\
tar -zxf libzip-1.5.2.tar.gz &&\
cd libzip-1.5.2 &&\
mkdir build &&\
cd build &&\
cmake .. &&\
make &&\
make install
```

3. 更新 lib

```shell
echo '/usr/local/lib64
/usr/local/lib
/usr/lib
/usr/lib64'>>/etc/ld.so.conf.d/local.conf

ldconfig
```

### 1.3. 安装 libiconv (可选)

```shell
wget https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.16.tar.gz
tar -zxf libiconv-1.16.tar.gz &&\
cd libiconv-1.16 &&\
./configure --prefix=/usr/local &&\
make
make install
ln -s /usr/local/lib/libiconv.2 /usr/lib64/
ldconfig
```

### 1.4. 安装 imap (可选)

centOS7 已经没有了 `libc-client`，需要编译安装

> 注：epel 源可以找到 libc-client-devel uw-imap-devel uw-imap-static uw-imap-utils，但直接安装还是会出现一些问题。

编译安装

```shell
wget ftp://ftp.cac.washington.edu/imap/imap-2007f.tar.gz
tar -zxf imap-2007f.tar.gz
cd imap-2007f
make lr5 PASSWDTYPE=std SSLTYPE=unix.nopwd EXTRACFLAGS=-fPIC IP=4
mkdir -p /usr/local/imap-2007f/{include,lib,c-client}
cp c-client/*.h /usr/local/imap-2007f/include/ && \
cp c-client/*.c /usr/local/imap-2007f/lib/  && \
cp c-client/*.c /usr/local/imap-2007f/c-client/  && \
cp c-client/c-client.a /usr/local/imap-2007f/lib/libc-client.a  && \
cp c-client/c-client.a /usr/local/imap-2007f/c-client/libc-client.a
```

备注：在 64 位下编译时 make 参数需要带 EXTRACFLAGS=-fPIC ，在 32 位下则不需要。

### 1.5. 其他(可选)

```shell
yum install -y libicu-devel libmcrypt-devel pam-devel bison bison-devel re2c
```

`libmcrypt-devel` 需要使用 epel 源

```shell
yum install -y epel-release
```

## 二、安装 PHP

### 2.1. 下载软件包

```bash
mkdir ~/packages && cd ~/packages && \
wget http://us.php.net/distributions/php-7.4.0.tar.gz  && \
tar zxf php-7.4.*.tar.gz -C /usr/local/src
```

### 2.2. 新增用户和组

```bash
groupadd -g 97 www-data && \
useradd -d / -g 97 -M -s /sbin/nologin -u 97 www-data
```

### 2.3. 编译安装

```bash
cd /usr/local/src/php-7.4.*

./configure \
  --prefix=/usr/local/php \
  --with-config-file-path=/usr/local/php/etc  \
  --with-config-file-scan-dir=/usr/local/php/conf.d  \
  --enable-fpm  \
  --with-fpm-user=www-data  \
  --with-fpm-group=www-data  \
  --with-fpm-systemd  \
  --with-openssl \
  --with-zlib \
  --enable-bcmath \
  --enable-calendar \
  --with-curl  \
  --enable-exif \
  --enable-gd  \
  --with-webp  \
  --with-jpeg  \
  --with-freetype  \
  --with-gettext  \
  --with-mhash \
  --enable-mbstring \
  --with-mysqli=mysqlnd \
  --with-pdo-mysql=mysqlnd \
  --enable-sockets \
  --with-xmlrpc \
  --with-xsl \
  --with-zip \
  --enable-mysqlnd

    #make ZEND_EXTRA_LIBS='-liconv' -j4
    make -j4
    make install
```

## 三、php 配置

- [PHP-FPM 配置 & 优化](https://segmentfault.com/a/1190000004190979)
- [PHP-FPM子进程数量应该如何设置？](https://segmentfault.com/a/1190000000630270)

### 3.1. php-fpm.conf 设置

```shell
mkdir /var/log/php-fpm/
cp /usr/local/php/etc/php-fpm.conf.default /usr/local/php/etc/php-fpm.conf
```

vim /usr/local/php/etc/php-fpm.conf

```shell
pid = /run/php-fpm.pid
error_log = /var/log/php-fpm/error.log
```

直接下载 php-fpm.conf

```shell
mkdir /var/log/php-fpm/
wget http://download.wangyan.org/conf/php/php-fpm.conf -P /usr/local/php/etc/
```

### 3.2. www.conf 设置

vim /usr/local/php/etc/php-fpm.d/www.conf

```plain
[www]
user = www-data
group = www-data

listen = /dev/shm/php-fpm.sock
listen.owner = nginx
listen.group = nginx
listen.mode = 0660
listen.allowed_clients = 127.0.0.1

pm = dynamic
pm.max_children = 100
pm.start_servers = 30
pm.min_spare_servers = 10
pm.max_spare_servers = 50
pm.max_requests = 512

pm.status_path = /status
ping.path = /ping

access.log = /var/log/php-fpm/$pool.access.log
slowlog = /var/log/php-fpm/$pool.log.slow
request_slowlog_timeout = 10s
request_terminate_timeout = 120
```

直接下载 www.conf

```shell
wget http://download.wangyan.org/conf/php/www.conf -P /usr/local/php/etc/php-fpm.d/
```

### 3.2. php.ini 设置

```shell
cp php.ini-production /usr/local/php/etc/php.ini

sed -i "s|;*date.timezone =.*|date.timezone = PRC|i" /usr/local/php/etc/php.ini && \
sed -i "s|;*memory_limit =.*|memory_limit = 512M|i" /usr/local/php/etc/php.ini && \
sed -i "s|;*upload_max_filesize =.*|upload_max_filesize = 32M|i" /usr/local/php/etc/php.ini && \
sed -i "s|;*max_file_uploads =.*|max_file_uploads = 20|i" /usr/local/php/etc/php.ini && \
sed -i "s|;*post_max_size =.*|post_max_size = 320M|i" /usr/local/php/etc/php.ini
```

直接下载 php.ini

```shell
wget http://download.wangyan.org/conf/php/php.ini -P /usr/local/php/etc/
```

### 3.2. 开机自启动

```shell
cp sapi/fpm/php-fpm.service  /usr/lib/systemd/system/
systemctl enable php-fpm
systemctl start php-fpm
```

直接下载 php-fpm.service

```shell
wget http://download.wangyan.org/conf/php/php-fpm.service -P /usr/lib/systemd/system/
touch /etc/sysconfig/php-fpm
```

### 3.3. 配置环境变量

```bash
cat >>/etc/profile<<'EOF'

PATH=$PATH:/usr/local/mysql/bin:/usr/local/php/bin:/usr/local/nginx/sbin:/usr/local/cmake/bin
export PATH
EOF

source /etc/profile
```
