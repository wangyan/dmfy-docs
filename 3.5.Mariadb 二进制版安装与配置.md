# Mariadb 二进制版安装与配置

## 一、MariaDB 准备

### 1.1. 下载

根据系统选择相应版本版本，然后下载解压。

```shell
mariadb-10.4.10-linux-glibc_214-x86_64.tar.gz
mariadb-10.4.10-linux-systemd-x86_64.tar.gz (推荐)
```

下载地址：<https://downloads.mariadb.org/>

clash 代理加速:

<https://github.com/Dreamacro/clash/releases>

```shell
export https_proxy=http://127.0.0.1:7890 && \
export http_proxy=http://127.0.0.1:7890
```

### 1.2. 安装依赖

```shell
yum -y install libaio-devel numactl-libs (centos)
dnf -y install ncurses-devel (centos8)
apt -y install build-essential libaio-dev
```

centos 8

```shell
ln -s /usr/lib64/libncurses.so.5.9 /usr/lib64/libncurses.so.5
ln -s /usr/lib64/libtinfo.so.5.9 /usr/lib64/libtinfo.so.5
```

## 二、安装 MariaDB

### 2.1. 添加用户组

```bash
groupadd -g 98 mysql && \
useradd -c "MariaDB server" -d / -g 98 -M -s /bin/false -u 98 mysql
```

### 2.2. 配置文件

<https://mariadb.com/kb/en/library/configuring-mariadb-with-option-files/#option-groups>

```shell
mkdir -p /var/log/mariadb  /etc/my.cnf.d && \
chown mysql:mysql /var/log/mariadb -R
```

vim /etc/my.cnf

```shell
cat >/etc/my.cnf<<'EOF'
#
# This group is read both by the client and the server
#
[client-server]
port=3306
socket=/dev/shm/mysql.sock

#
# include all files from the config directory
#
!includedir /etc/my.cnf.d
EOF
```

vim /etc/my.cnf.d/client.cnf

```shell
cat >/etc/my.cnf.d/client.cnf<<'EOF'
#
# These two groups are read by the client library
# Use it for options that affect all clients, but not the server
#
[client]
default-character-set = utf8mb4

#
# This group is not read by mysql client library,
#
[client-mariadb]
EOF
```

vim /etc/my.cnf.d/server.cnf

```shell
cat >/etc/my.cnf.d/server.cnf<<'EOF'
#
# This groups are read by MariaDB server.
# Use it for options that only the server (but not clients)
#
[server]

#
# This group is read both by the MariaDB Server and MySQL Server.
#
[mysqld]
datadir=/var/lib/mysql
bind-address=0.0.0.0
pid-file=/var/run/mariadb/mariadb.pid

character-set-server=utf8mb4
character-set-filesystem=utf8mb4
collation-server=utf8mb4_general_ci

#
# This group is only read by MariaDB servers, not by MySQL.
#
[mariadb]
log_error=/var/log/mariadb/mariadb.err
aria_log_dir_path=/var/log/mariadb

## Binary Log
log_bin=/var/log/mariadb/mariadb-bin
log_bin_index=/var/log/mariadb/mariadb-bin.index
binlog_format=mixed
expire-logs-days=90

## Slow Query Log
slow-query-log=1
slow_query_log_file=/var/log/mariadb/mariadb-slow
long_query_time=10

## MariaDB Audit Plugin
plugin-load=server_audit=server_audit.so
server_audit=FORCE_PLUS_PERMANENT
server_audit_events=CONNECT,QUERY,TABLE
server_audit_logging=ON
server_audit_file_path=logs/mariadb-audit.log
EOF
```

### 2.3. 安装

```shell
mkdir -p /usr/local/mariadb/ && \
tar -zxf mariadb-10.4.11-linux-systemd-x86_64.tar.gz -C /usr/local/mariadb && \
ln -s /usr/local/mariadb/mariadb-10.4.11-linux-systemd-x86_64 /usr/local/mysql && \
cd /usr/local/mysql && \
./scripts/mysql_install_db --user=mysql

chown -R 0:0 . && \
chown -R mysql data
```

### 2.4. 开机自启动

方法1：

<https://mariadb.com/kb/en/mariadb/systemd/>

```shell
#wget http://download.wangyan.org/conf/mariadb/mariadb.service -P /usr/lib/systemd/system

cp support-files/systemd/mariadb.service /usr/lib/systemd/system/mariadb.service
systemctl enable mariadb.service
systemctl start mariadb.service
systemctl disable mariadb.service
```

方法2：

```shell
cp support-files/mysql.server /etc/init.d/mysql
chkconfig mysql on
service mysql start
```

手动启动

```shell
export PATH=$PATH:/usr/local/mysql/bin/
echo 'export PATH=$PATH:/usr/local/mysql/bin/' >> ~/.bashrc
mysqld_safe --user=mysql &
```

## 三、设置 MariaDB

### 3.1. 初始化设置

MariaDB 10.4+ 以后，root 帐号认证机制已经变更，详见官网说明：

<https://mariadb.org/authentication-in-mariadb-10-4/>

root 帐号登录：

```shell
# su mysql; mysql -umysql
sudo mysql
```

重置 root 密码：

```shell
ALTER USER root@localhost IDENTIFIED VIA mysql_native_password USING PASSWORD("new-password");
```

MariaDB 10.4 以前版本使用以下方法：

```shell
/usr/local/mysql/bin/mysqladmin -u root -h 'hosts-name' password 'new-password'
/usr/local/mysql/bin/mysql_secure_installation
```

### 3.2. 开启远程登录

```shell
mysql -uroot -p
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'new-password' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

### 3.3. 解决 MariaDB 中文乱码

<https://mariadb.com/kb/en/mariadb/setting-character-sets-and-collations/>

```shell
vim /etc/my.cnf

[client]
...
default-character-set = utf8mb4
...
[mysql]
...
default-character-set = utf8mb4

...
[mysqld]
...
character-set-server  = utf8mb4
character-set-filesystem = utf8mb4
collation-server      = utf8mb4_general_ci
...
```

查看效果

```shell
mysql -uroot -p
SHOW VARIABLES WHERE Variable_name LIKE 'character\_set\_%' OR Variable_name LIKE 'collation%';
```

### 3.4. 数据备份

Exporting MySQL database to a dump file

```bash
mysqldump -u root -p --opt [database name] > [database name].sql
```

Another export & import option

```bash
mysqldump -u root -pPassword --all-databases | ssh user@new_host.host.com 'cat - | mysql -u root -pPassword'
```

Secure the backup file

```bash
zip --encrypt dump.zip db.sql
unzip -P your-password dump.zip
```

Import MySQL dump to new server

```bash
mysql -u root -p newdatabase < /path/to/newdatabase.sql
```

### 3.5. 其他

错误修复

```shell
mysqlcheck --all-databases --check-upgrade --auto-repair
mysql_upgrade -uroot -p --force
```

```shell
vim /etc/my.cnf

[client]
socket          = /dev/shm/mysql.sock

[mysqld]
bind-address    = 0.0.0.0
socket          = /dev/shm/mysql.sock
```

官方文档：

- [《Installing MariaDB Binary Tarballs》](https://mariadb.com/kb/en/mariadb/installing-mariadb-binary-tarballs)
- [《Server System Variables》](https://mariadb.com/kb/en/library/server-system-variables)
- [《Configuring MariaDB with Option Files》](https://mariadb.com/kb/en/library/configuring-mariadb-with-option-files/)
